---
tags: [design-pattern, kotlin, behavioral]
---

# 방문자 패턴

## 한 줄 요약

객체 구조를 변경하지 않고 새로운 연산을 추가할 수 있게 하는 패턴

## 핵심 정리

- 합성 패턴과 절친
- 쓸모 있을지 논란의 대상
- 장황한 코드와 강한 결합이 단점

## 상세 내용

### 구현 예제

```kotlin
fun main() {
    val page = Page(
        Container(
            Image,
            Link,
            Image
        ),
        Table,
        Link,
        Container(
            Table,
            Link
        ),
        Container(
            Image,
            Container(
                Image,
                Link
            )
        )
    )

    println(collectLinks(page))
}

fun collectLinks(page: Page): List<String> {
    return LinksCrawler().run {
        page.accept(this)
        this.links
    }
}

class LinksCrawler {
    private var _links = mutableListOf<String>()

    val links
        get() = _links.toList()

    fun visit(page: Page) {
        visit(page.elements)
    }

    fun visit(container: Container) = visit(container.elements)

    private fun visit(elements: List<HtmlElement>) {
        for (e in elements) {
            when (e) {
                is Container -> e.accept(this)
                is Link -> _links.add(e.href)
                is Image -> _links.add(e.src)
                else -> {
                }
            }
        }
    }
}

private fun Container.accept(feature: LinksCrawler) {
    feature.visit(this)
}

private fun Page.accept(feature: LinksCrawler) = feature.visit(this)

class Page(val elements: MutableList<HtmlElement> = mutableListOf()) {
    constructor(vararg elements: HtmlElement) : this(mutableListOf()) {
        for (s in elements) {
            this.elements.add(s)
        }
    }
}

sealed class HtmlElement

class Container(val elements: MutableList<HtmlElement> = mutableListOf()) : HtmlElement() {
    constructor(vararg units: HtmlElement) : this(mutableListOf()) {
        for (u in units) {
            this.elements.add(u)
        }
    }
}

object Image : HtmlElement() {
    val src: String
        get() = "https://some.image"
}

object Link : HtmlElement() {
    val href: String
        get() = "https://some.link"
}

object Table : HtmlElement()
```

### 특징

- 복잡한 객체 구조를 순회하며 특정 작업 수행
- `accept()` 메서드를 통한 이중 디스패치
- 확장 함수로 `accept()` 구현 가능
- 새로운 연산 추가는 쉽지만 새로운 요소 추가는 어려움

---

**출처**
- 코틀린 디자인 패턴
